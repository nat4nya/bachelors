{% extends 'main/base_home.html' %}
{% block title %} Professor Home {% endblock %}
{% block content %}

<style>
  /* Custom CSS for larger headings */
  .accordion-item h2.accordion-header button.accordion-button {
    font-size: 1.5rem; /* Adjust the font size as needed */
  }
</style>

<!-- Modal for confirmation -->
<div class="modal fade" id="confirmRejectModal" tabindex="-1" aria-labelledby="confirmRejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmRejectModalLabel">Confirm Rejection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="reason">Reason for rejection:</label>
        <textarea class="form-control" id="reason" name="reason" rows="4" placeholder="Enter your reason here..." required></textarea>
        <!-- Hidden input field to store the note ID -->
        <input type="hidden" id="refuseNoteId" name="note_id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <!-- Yes, Reject button -->
        <button type="submit" class="btn btn-danger" id="rejectButton">Yes, Reject</button>
      </div>
    </div>
  </div>
</div>

<div class="m-4">
  <div class="accordion" id="myAccordion">
      <div class="accordion-item">
          <h2 class="accordion-header" id="headingOne">
              <button type="button" class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseOne">Cereri acceptate</button>
          </h2>
          <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#myAccordion">
              <div class="card-body">
                  <ul>
                    {% for note in notes_received %}
                      {% if note.is_accepted %}
                        <li>
                          <strong>Student:</strong> {{ note.author.username }}<br>
                          <strong>Titlul lucrarii:</strong> {{ note.title }}<br>
                          <strong>Descrierea lucrarii:</strong> {{ note.description }}
                        </li>
                      {% endif %}
                    {% endfor %}
                  </ul>
              </div>
          </div>
      </div>
      <div class="accordion-item">
          <h2 class="accordion-header" id="headingTwo">
              <button type="button" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">Cereri in asteptare</button>
          </h2>
          <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#myAccordion">
              <div class="card-body">
                  <ul>
                    {% for note in notes_received %}
                      {% if not note.is_accepted %}
                        <li>
                          <strong>Student:</strong> {{ note.author.username }}<br>
                          <strong>Titlul lucrarii:</strong> {{ note.title }}<br>
                          <strong>Descrierea lucrarii:</strong> {{ note.description }}<br>
                          <!-- Accept button -->
                          <form id="acceptForm_{{ note.id }}" action="{% url 'accept_note' note.id %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">Accept</button>
                          </form>
                          <!-- Refuse button form -->
                          <form id="refuseForm_{{ note.id }}" action="{% url 'refuse_note' note.id %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="note_id" value="{{ note.id }}">
                            <button type="button" class="btn btn-danger refuse-btn" data-bs-toggle="modal" data-bs-target="#confirmRejectModal" data-note-id="{{ note.id }}">Refuse</button>
                          </form>
                        </li>
                      {% endif %}
                    {% endfor %}
                  </ul>
              </div>
          </div>
      </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const rejectButton = document.getElementById('rejectButton');
    const reasonInput = document.getElementById('reason');
    let noteIdToReject = null;

    rejectButton.addEventListener('click', function() {
      const reason = reasonInput.value;

      if (noteIdToReject && reason) {
        const formData = new FormData();
        formData.append('note_id', noteIdToReject);
        formData.append('reason', reason);

        fetch('/home-professor', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => {
          if (response.ok) {
            alert('Note rejected successfully.');
            window.location.href = '/home-professor';
          } else {
            alert('An error occurred while processing the rejection request. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while processing the rejection request. Please try again.');
        });
      } else {
        alert('Please select a reason for rejection.');
      }
    });

    // JavaScript to handle refusal process
    const refuseButtons = document.querySelectorAll('.refuse-btn');
    refuseButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        noteIdToReject = button.getAttribute('data-note-id');
      });
    });
  });
</script>

{% endblock %}
